import{p as N,l as Re,u as ve,r as je,g as He,a as ue,b as de,c as $e,d as Ye,e as Je}from"./knowledge-D-I8rEGo.js";import{r as s,aS as qe,aE as T,a3 as Y,aK as Z,aU as Qe,_ as Xe,b as Ge,Q as Ze,Y as pe,E as fe,e as _,c as I,o as k,m,f as o,k as y,aV as el,aC as E,h as u,L as H,am as $,n as V,A as U,j as ll,aW as al,aX as tl,aY as nl,i as ol,t as sl,v as il}from"./index-BehJRYYk.js";import{E as G,K as ul}from"./KonwledgeOption-C14HPhe3.js";import"./mitt-DJ65BbbF.js";function dl(n){const i=[...N.keys()];for(let v=0;v<i.length;++v)if(i[v]!==n){const f=N.get(i[v]);console.log(`关闭了${i[v]}的轮询`),clearInterval(f),N.delete(i[v])}}function rl(n){if(N.has(n)){const i=N.get(n);clearInterval(i),console.log("关闭了"),N.delete(n)}}function cl(n){return n==="green"?"success":n==="gray"?"warning":"danger"}function gl(n){return n==="green"?"上传成功":n==="gray"?"正在上传":"上传失败"}function vl(n){return["md","txt","pdf","jpg","png","jpeg","docx","xlsx","pptx","eml","csv"].includes(n.split(".").pop().toLowerCase())}function pl(n,i){return n===""||i===""?(T({type:"warning",message:"请输入完整信息"}),!1):!0}function fl(n){if(ml(n))return"无";let i=[];const v={display:"flex",justifyContent:"center",alignItems:"center",margin:"6px",fontSize:"14px"};for(let f in n)i.push(Y(Z,{key:f,style:v,type:"warning",size:"large"},{default:()=>`${f} : ${n[f]}`}));return Y(Qe,{maxHeight:"100px",overflow:"visible",onwheel:f=>{let w=f.target;for(;w&&w.parentElement&&![...w.classList].includes("el-scrollbar__view");)w=w.parentElement;w&&[...w.classList].includes("el-scrollbar__view")&&f.stopPropagation()}},i)}function ml(n){return n==null||JSON.stringify(n)=="{}"}function wl(n,i="正在加载中"){const v=s(null);return v.value=qe.service({target:n,fullscreen:!1,text:i}),v}function me(n){n.value.close()}function hl(n){n.length;for(let i=0;i<length;++i)if(n[i].status==="gray")return!1;return!0}const we=n=>(sl("data-v-1a8a2f3e"),n=n(),il(),n),yl={class:"container"},_l={class:"add-knowledge"},bl={class:"title-and-add-btn"},xl=we(()=>m("span",{class:"left-title"},"知识库",-1)),kl={class:"knowledge-table"},Cl={class:"knowledge-title"},Il={class:"upload-card"},Vl={class:"upload-card-column-1"},Kl={class:"upload-card-column-2"},El={class:"upload-card-column-3"},Tl={key:0,style:{marginRight:"10px"}},Al={class:"chosen-files-box"},Ll=["onClick"],Sl={class:"uploaded-file-list"},Fl=we(()=>m("span",{style:{color:"red",cursor:"pointer",userSelect:"none"}},"删除",-1)),Ul={__name:"index",setup(n){const i=s(null),v=s(!1),f=s(""),w=s([]),z=s(""),B=s(""),J=s(!1),ee=s(null),le=s(0),ae=s(0),te=s(0);let ne=!1,q=[];const M=s(null),he=[{label:"私有",value:1},{label:"公开",value:0}],h=s([]),ye=s(0),K=s([]),re=s(null),P=s(""),D=s(""),r=s([]);s([]);const O=s(!1),W=s(""),c=s([]),d=s(c.value[0]&&c.value[0].id||0),R=s(c.value[0]&&c.value[0].name||"默认知识库"),S=new Map;let _e=[{key:"id",dataKey:"id",title:"ID",width:"10%",align:"center"},{key:"name",dataKey:"name",title:"名称",width:"25%",align:"center"},{key:"status",dataKey:"status",title:"状态",width:"10%",align:"center",cellRenderer:({cellData:l})=>Y(Z,{type:cl(l),size:"large",disableTransitions:!0},{default:()=>gl(l)})},{key:"institution",dataKey:"institution",title:"机构",width:"18%",align:"center"},{key:"date",dataKey:"date",title:"发行日期",width:"10%",align:"center"},{key:"tag",dataKey:"tag",title:"标签",width:"22%",align:"center",cellRenderer:({cellData:l})=>Y("DIV",null,fl(l))},{key:"operate",dataKey:"operate",title:"操作",width:"15%",align:"center",cellRenderer:({rowData:l})=>Y(E,{type:"danger",onClick:()=>ze(l.id),disabled:!v.value},{default:()=>"删除"})}];function Q(l=!1){He().then(async e=>{c.value=e.data,d.value=d.value?d.value:c.value[0]&&c.value[0].id||0,l&&(R.value=c.value.find(g=>g.id===d.value).name),ge();const t=await ue(d.value);h.value=t[0].data,console.log("documentDocList.value",h.value),oe(t[1].data),de(d.value,h.value)})}Ge().getInfo().then(l=>{f.value={roleKey:l.user.roles[0].roleKey,userId:l.user.userId,userName:l.user.userName},console.log("当前用户为",f.value)});function oe(l){const e=h.value.length;for(let t=0;t<e;++t){const{id:g}=h.value[t];if(g==="创建中")continue;const p=l.find(A=>A.id===g);if(!p)continue;const{status:x}=p;h.value[t].status=x}}const ce=Re.throttle(be,500);Ze(()=>{const l=ee.value.offsetWidth,e=window.innerHeight,t=window.innerWidth;le.value=e-50-90,ae.value=e-170,te.value=t-l-90,window.addEventListener("resize",ce)}),pe(()=>window.removeEventListener("resize",ce));function be(){const l=ee.value.offsetWidth,e=window.innerHeight,t=window.innerWidth;le.value=e-50-90,ae.value=e-170,te.value=t-l-90}Q(!0),G.on("renameKnowledge",function({id:l,newName:e,type:t}){d.value==l&&(R.value=e),ve(l,e,t)}),G.on("removeKnowledge",async function({id:l}){const e=d.value==l;fe.confirm("是否删除文档",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{e&&rl(l),await je(l),T({type:"success",message:"删除知识库成功"});const t=c.value.findIndex(g=>g.id==l);c.value.splice(t,1),await Q(),e&&(d.value=c.value.length>0?c.value[0].id:0,R.value=c.value.length>0?c.value[0].name:"默认知识库",h.value=c.value.length>0?c[0]:[])})}),G.on("switchType",async function({id:l,name:e,type:t}){await ve(l,e,t);const g=c.value.findIndex(p=>p.id===l);c.value[g].type=t}),pe(()=>{G.all.clear()});async function xe(l){let e=l.target;for(;e.parentElement&&![...e.classList].includes("knowledge-option-hover");)e=e.parentElement;d.value=parseInt(e.dataset.id),console.log(parseInt(e.dataset.id));const t=e.textContent.slice(2);if(t==="")return;R.value=t;const g=wl(i.value);ge();let p;try{p=await ue(d.value)}catch{me(g)}h.value=p[0].data,oe(p[1].data),me(g),dl(d.value),!(h.value.length===0||hl(h.value))&&de(d.value,h.value)}async function ke(){if(W.value===""||M.value!==0&&M.value!==1){T({type:"warning",message:"请输入完整信息"});return}await $e(null,W.value,M.value),Q(),W.value="",J.value=!1}function Ce(l){if(l.target.nodeName==="DIV"&&[...l.target.parentElement.classList].includes("container")){const e=l.target.parentElement.style.backgroundColor;e&&e!=="rgb(108, 143, 233)"&&(l.target.parentElement.style.backgroundColor="rgb(215, 222, 242)")}}function Ie(l){if(l.target.nodeName==="DIV"&&[...l.target.classList].includes("container")){const e=l.target.style.backgroundColor;e&&e!=="rgb(108, 143, 233)"&&(l.target.style.backgroundColor="rgb(235, 237, 248)")}}let F=0;async function Ve(l){++F;const{file:e}=l,{uid:t}=e,{organization:g,date:p,tag:x}=r.value.find(({file:C})=>C.uid===t);console.log("uploadFileList.value:",r.value);let A={};for(let C=0;C<x.length;++C)A[x[C].tagName]=x[C].tagContent;if(S.set(t,A),F===r.value.length){r.value.forEach(b=>{h.value.unshift({id:"创建中",name:b.file.name,date:b.date,institution:b.organization,status:"gray",tag:null})});const C=d.value;console.log("uploadFileList",r.value);const se=r.value.map(b=>({filename:b.file.name,date:b.date,institution:b.organization,tag:JSON.stringify(S.get(b.file.uid))})),ie=r.value.map(b=>b.file.raw);if(await Ye(d.value,se,ie),d.value!=C)return;const X=await ue(d.value);h.value=X[0].data,oe(X[1].data),de(d.value,h.value)}}function Ke(l,e,t){F===r.value.length&&F>0&&(T({type:"success",message:"文件上传中"}),r.value=[],K.value=[],F=0,S.clear(),console.log(S))}function Ee(l){r.value=[],K.value=[],F=0,S.clear(),console.log(S)}function Te(){if(r.value.length===0){T({type:"warning",message:"请添加文件"});return}re.value.submit(),O.value=!1}function Ae(l,e){console.log("选择的文件是",l),l.status==="ready"&&K.value.push(l)}function Le(){pl(D.value,P.value)&&(K.value.forEach(l=>{r.value.unshift({file:l,organization:D.value,date:P.value,tag:w.value})}),D.value="",P.value="",K.value=[],w.value=[])}function Se(l){const e=K.value.findIndex(t=>t.name===l);K.value.splice(e,1)}async function Fe(l,e,t){if(t.target.nodeName!=="SPAN"||t.target.textContent!=="删除")return;const{name:g}=l,p=r.value.findIndex(({file:x})=>x.name===g);r.value.splice(p,1)}function Ue(){r.value=[],K.value=[],O.value=!1}function Ne(l){const{uid:e,name:t}=l;if(!vl(t))return ne||(ne=!0,T({type:"warning",message:"仅支持上传md,txt,pdf,jpg,png,jpeg,docx,xlsx,pptx,emk,csv文件"}),setTimeout(()=>ne=!1,3e3)),r.value=r.value.filter(({file:p})=>p.raw.uid!==e),!1;const g=!!r.value.find(({file:p})=>p.uid===e);return console.log(`${e}这个文件存在吗`,g),!!g}function ze(l){if(l==="创建中"){T({type:"warning",message:"上传中文件无法删除"});return}fe.confirm("确认删除该文档吗?",{confirmButtonText:"确认",cancelButtonText:"取消"}).then(async()=>{try{await Be(l),T({type:"success",message:"删除成功"})}catch(e){console.log(e)}}).catch(e=>{console.log(e)})}async function Be(l){if(!q.includes(l)){q.push(l);try{await Je(d.value,l)}catch(e){throw console.log("删除文件报错:",e),new Error("删除文件失败")}finally{const e=q.findIndex(t=>l);q.splice(e,1)}Q()}}function Me(){B.value!==""&&z.value!==""?(w.value.unshift({tagName:B.value,tagContent:z.value}),B.value="",z.value=""):T({type:"warning",message:"请输入完整标签信息"})}function Pe(l){console.log(l);const e=w.value.findIndex(t=>t.tagName===l);w.value.splice(e,1)}function ge(){const l=c.value.find(e=>e.id===d.value).creator;if(console.log("这个知识库的创建者为:",l),console.log("cc",f.value),l===f.value.userName||f.value.roleKey==="admin"){v.value=!0;return}v.value=!1,console.log("isCanModify",v.value)}return(l,e)=>{const t=_("el-input"),g=_("el-option"),p=_("el-select"),x=_("el-dialog"),A=_("el-scrollbar"),C=_("el-date-picker"),se=_("upload-filled"),ie=_("el-icon"),X=_("el-upload"),b=_("el-link"),j=_("el-table-column"),De=_("el-table"),Oe=_("el-table-v2"),We=_("el-auto-resizer");return k(),I("div",yl,[m("div",{class:"knowledge-options",ref_key:"knowledgeOptionsRef",ref:ee},[m("div",_l,[m("div",bl,[xl,o(y(E),{icon:y(el),circle:"",color:"#d7def2",class:"add-knowledge-btn",onClick:e[0]||(e[0]=a=>J.value=!0)},null,8,["icon"])]),o(x,{modelValue:J.value,"onUpdate:modelValue":e[3]||(e[3]=a=>J.value=a),class:"add-knowledge-dialog",title:"新增知识库"},{default:u(()=>[o(t,{class:"add-knowledge-inp",placeholder:"请输入知识库名称",modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=a=>W.value=a)},null,8,["modelValue"]),o(p,{modelValue:M.value,"onUpdate:modelValue":e[2]||(e[2]=a=>M.value=a),placeholder:"请选择知识库类型",class:"add-knowledge-type-selector"},{default:u(()=>[(k(),I(H,null,$(he,a=>o(g,{key:a.value,label:a.label,value:a.value,disabled:f.value.roleKey==="user"&&a.label==="公开"},null,8,["label","value","disabled"])),64))]),_:1},8,["modelValue"]),o(y(E),{class:"add-knowledge-btn",onClick:ke},{default:u(()=>[V("新增")]),_:1})]),_:1},8,["modelValue"])]),o(A,{"max-height":le.value+"px",class:"scroll"},{default:u(()=>[(k(!0),I(H,null,$(c.value,a=>(k(),I("div",{class:"knowledge-option",key:a.id},[o(ul,{name:a.name,id:a.id,type:a.type,onClick:e[4]||(e[4]=L=>xe(L)),isActive:d.value==a.id,creator:a.creator,currentUser:f.value,class:"knowledge-option-hover",onMouseover:Ce,onMouseleave:Ie},null,8,["name","id","type","isActive","creator","currentUser"])]))),128))]),_:1},8,["max-height"])],512),m("div",kl,[m("div",Cl,[m("span",null,U(R.value),1)]),o(y(E),{class:"upload-document-btn",size:"large",onClick:e[5]||(e[5]=()=>O.value=!0),disabled:!v.value},{default:u(()=>[V("上传文档")]),_:1},8,["disabled"]),o(x,{modelValue:O.value,"onUpdate:modelValue":e[10]||(e[10]=a=>O.value=a),class:"upload-document-dialog",closeOnClickModal:!1,"show-close":!1},{default:u(()=>[m("div",Il,[m("div",Vl,[o(t,{modelValue:D.value,"onUpdate:modelValue":e[6]||(e[6]=a=>D.value=a),style:{width:"240px"},placeholder:"请输入机构",class:"upload-organization","prefix-icon":y(al)},null,8,["modelValue","prefix-icon"]),o(C,{modelValue:P.value,"onUpdate:modelValue":e[7]||(e[7]=a=>P.value=a),type:"date",class:"data-picker",placeholder:"请输入日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"]),o(X,{class:"upload-document-region",multiple:"",action:"http://10.16.53.4:8080/knowledgeBase/uploadFiles","show-file-list":!1,"file-list":r.value,"http-request":Ve,"auto-upload":!1,"on-success":Ke,"on-error":Ee,"on-change":Ae,ref_key:"uploadRef",ref:re,"before-upload":Ne,accept:".md, .txt, .jpg, .png, .jpeg, .docx, .xlsx, .pptx, .eml, .csv, .pdf"},{default:u(()=>[o(y(E),{class:"upload-document-region-btn"},{default:u(()=>[o(ie,null,{default:u(()=>[o(se)]),_:1}),V("上传文件")]),_:1})]),_:1},8,["file-list","accept"])]),m("div",Kl,[o(t,{modelValue:B.value,"onUpdate:modelValue":e[8]||(e[8]=a=>B.value=a),placeholder:"请输入标签名称",class:"tag-name","prefix-icon":y(tl)},null,8,["modelValue","prefix-icon"]),o(t,{modelValue:z.value,"onUpdate:modelValue":e[9]||(e[9]=a=>z.value=a),placeholder:"请输入标签内容",class:"tag-content","prefix-icon":y(nl)},null,8,["modelValue","prefix-icon"]),o(y(E),{class:"add-label-btn",onClick:Me},{default:u(()=>[V("添加标签")]),_:1})]),m("div",El,[o(y(E),{class:"upload-add-btn",onClick:Le,type:"primary",plain:""},{default:u(()=>[V("添加文件")]),_:1})])]),w.value.length>=1?(k(),I("span",Tl,"已添加标签")):ll("",!0),(k(!0),I(H,null,$(w.value,a=>(k(),I("div",{key:a.tagName,class:"added-label"},[o(y(Z),{type:"warning",closable:"",onClose:L=>Pe(a.tagName)},{default:u(()=>[V(U(a.tagName)+" : "+U(a.tagContent),1)]),_:2},1032,["onClose"])]))),128)),m("div",Al,[o(A,{"max-height":"200px"},{default:u(()=>[(k(!0),I(H,null,$(K.value,a=>(k(),I("div",{class:"chosen-file",key:a.name},[o(b,{class:"chosen-file-name"},{default:u(()=>[V(U(a.name),1)]),_:2},1024),m("span",{class:"chosen-file-del-btn",onClick:L=>Se(a.name)},"删除",8,Ll)]))),128))]),_:1})]),m("div",Sl,[o(De,{data:r.value.map(a=>({name:a.file.name,organization:a.organization,date:a.date,tag:a.tag})),"max-height":"500","current-row-key":ye.value,onRowClick:Fe},{default:u(()=>[o(j,{prop:"name",label:"文件名","min-width":"20%"}),o(j,{prop:"organization",label:"机构","min-width":"20%"}),o(j,{prop:"date",label:"发行日期","min-width":"20%"}),o(j,{prop:"tag",label:"标签","min-width":"20%"},{default:u(({row:a})=>[o(A,null,{default:u(()=>[(k(!0),I(H,null,$(a.tag,L=>(k(),ol(y(Z),{key:L.tagName,style:{display:"flex",margin:"4px"},type:"warning"},{default:u(()=>[V(U(L.tagName)+" : "+U(L.tagContent),1)]),_:2},1024))),128))]),_:2},1024)]),_:1}),o(j,{label:"操作",fixed:"right","min-width":"20%"},{default:u(()=>[Fl]),_:1})]),_:1},8,["data","current-row-key"])]),o(y(E),{onClick:Ue,class:"upload-cancel"},{default:u(()=>[V("取消上传")]),_:1}),o(y(E),{onClick:Te,class:"upload-confirm",type:"primary"},{default:u(()=>[V("全部上传")]),_:1})]),_:1},8,["modelValue"]),m("div",{class:"document-table",ref_key:"virtualTable",ref:i},[o(We,null,{default:u(()=>[o(Oe,{columns:y(_e),data:h.value,width:te.value,height:ae.value,headerClass:"virtual-table-header",fixed:!1,cache:10,"row-height":120},null,8,["columns","data","width","height"])]),_:1})],512)])])}}},Dl=Xe(Ul,[["__scopeId","data-v-1a8a2f3e"]]);export{Dl as default};
